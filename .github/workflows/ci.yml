name: CI - Monorepo with Selective Builds

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      web: ${{ steps.changes.outputs.web }}
      doc: ${{ steps.changes.outputs.doc }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect changes in components
        id: changes
        run: |
          # For pull requests, compare with base branch
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            DIFF="git diff --name-only $BASE_SHA $HEAD_SHA"
          else
            # For pushes, compare with previous commit
            DIFF="git diff --name-only HEAD~1 HEAD"
          fi
          
          # Check backend changes
          if $DIFF | grep -q "^backend/"; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "Backend changes detected"
          else
            echo "backend=false" >> $GITHUB_OUTPUT
            echo "No backend changes"
          fi
          
          # Check web changes
          if $DIFF | grep -q "^web/"; then
            echo "web=true" >> $GITHUB_OUTPUT
            echo "Web changes detected"
          else
            echo "web=false" >> $GITHUB_OUTPUT
            echo "No web changes"
          fi
          
          # Check documentation changes
          if $DIFF | grep -q "^doc/"; then
            echo "doc=true" >> $GITHUB_OUTPUT
            echo "Documentation changes detected"
          else
            echo "doc=false" >> $GITHUB_OUTPUT
            echo "No documentation changes"
          fi

  backend-test:
    name: Backend Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: app
          POSTGRES_PASSWORD: app
          POSTGRES_DB: fishing
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Run tests
        run: |
          cd backend
          ./mvnw clean test
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/fishing
          SPRING_DATASOURCE_USERNAME: app
          SPRING_DATASOURCE_PASSWORD: app
      
      - name: Build package
        run: |
          cd backend
          ./mvnw package -DskipTests

  web-test:
    name: Web Tests and Build
    needs: detect-changes
    if: needs.detect-changes.outputs.web == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json
      
      - name: Install dependencies
        run: |
          cd web
          npm ci
      
      - name: Lint
        run: |
          cd web
          npm run lint
      
      - name: Build
        run: |
          cd web
          npm run build

  doc-check:
    name: Documentation Check
    needs: detect-changes
    if: needs.detect-changes.outputs.doc == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check markdown files
        run: |
          echo "Checking documentation files..."
          find doc -name "*.md" -type f | while read file; do
            echo "Checking: $file"
            # Basic markdown validation (links, etc.)
            if ! grep -q "^#" "$file"; then
              echo "Warning: $file may not have proper headings"
            fi
          done
      
      - name: Validate OpenAPI spec (if exists)
        if: hashFiles('doc/api/openapi.yaml') != ''
        run: |
          echo "OpenAPI validation would go here"
          # TODO: Add openapi-validator when API spec is created

  all-checks:
    name: All Checks Passed
    needs: [backend-test, web-test, doc-check]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check status
        run: |
          if [ "${{ needs.backend-test.result }}" = "failure" ] || \
             [ "${{ needs.web-test.result }}" = "failure" ] || \
             [ "${{ needs.doc-check.result }}" = "failure" ]; then
            echo "Some checks failed"
            exit 1
          fi
          echo "All checks passed or skipped"
